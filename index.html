<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser CSV Analyzer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-50 text-slate-700 antialiased">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-xl font-bold text-slate-800">CSV Analysis (Client Side)</h1>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-10">
        
        <div class="bg-white rounded-xl shadow p-6 mb-8 border border-slate-200">
            <h2 class="text-lg font-bold mb-4">データ解析設定</h2>
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <input type="file" id="csvFile" accept=".csv" 
                       class="block w-full text-sm text-slate-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-full file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100 cursor-pointer"/>
                
                <button onclick="processCSV()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                    解析実行
                </button>
            </div>
        </div>

        <div id="results" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow border border-slate-100">
                    <div class="text-sm text-slate-400">データ行数</div>
                    <div class="text-2xl font-bold text-slate-800" id="rowCount">-</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow border border-slate-100">
                    <div class="text-sm text-slate-400">平均値 (例)</div>
                    <div class="text-2xl font-bold text-blue-600" id="avgValue">-</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow border border-slate-100">
                    <div class="text-sm text-slate-400">最大値 (例)</div>
                    <div class="text-2xl font-bold text-green-600" id="maxValue">-</div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow border border-slate-200">
                <canvas id="myChart"></canvas>
            </div>
        </div>

    </main>

    <script>
        let myChart = null; // グラフの入れ物

        function processCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert("ファイルを選択してください");
                return;
            }

            // CSVを読み込む処理 (PapaParse使用)
            Papa.parse(file, {
                header: true,        // 1行目を項目名として扱う
                dynamicTyping: true, // 数字を自動で数値として扱う
                skipEmptyLines: true,// 空行をスキップ
                // ★重要: 列名の前後の空白を削除する設定を追加しました
                transformHeader: function(header) {
                    return header.trim();
                },
                complete: function(results) {
                    // 読み込み完了！ results.data に中身が入っています
                    analyzeData(results.data);
                }
            });
        }

        // ▼▼▼ 御主人様のデータに合わせて調整した解析ロジック ▼▼▼
        function analyzeData(data) {
            console.log("読み込んだデータ:", data);

            // データが空でないかチェック
            if (data.length === 0) {
                alert("データ読み込みに失敗しました。CSVの中身を確認してください。");
                return;
            }

            // 1. 必要なデータを抽出
            // CSVの列名: time, distance, azimuth, elevation, ...
            const labels = data.map(row => row.time);     // 横軸: 時間
            const distances = data.map(row => row.distance); // 縦軸: 距離
            
            // データから「undefined」を除外（空行対策）
            const cleanDistances = distances.filter(d => typeof d === 'number');

            // 2. 計算ロジック (距離の統計)
            const count = cleanDistances.length;
            const sum = cleanDistances.reduce((a, b) => a + b, 0);
            const avg = count > 0 ? (sum / count).toFixed(2) : 0;
            const max = count > 0 ? Math.max(...cleanDistances) : 0;

            // 3. 画面上の数値を更新
            // HTML側のIDに合わせて値をセットします
            const rowCountEl = document.getElementById('rowCount');
            if(rowCountEl) rowCountEl.innerText = count + " 行";
            
            const avgValEl = document.getElementById('avgValue');
            if(avgValEl) avgValEl.innerText = avg + " cm"; // 単位は推測(cm)

            const maxValEl = document.getElementById('maxValue');
            if(maxValEl) maxValEl.innerText = max + " cm";

            // 4. グラフを描画
            drawChart(labels, distances);

            // 結果エリアを表示
            const resultDiv = document.getElementById('results');
            if(resultDiv) resultDiv.classList.remove('hidden');
        }
        // ▲▲▲ 解析ロジックここまで ▲▲▲

        function drawChart(labels, dataPoints) {
            const ctx = document.getElementById('myChart').getContext('2d');
            
            // 前のグラフがあれば消す
            if (myChart) {
                myChart.destroy();
            }

            // 新しいグラフを描く
            myChart = new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: labels, // X軸: time
                    datasets: [{
                        label: 'Distance (距離)',
                        data: dataPoints, // Y軸: distance
                        borderColor: 'rgb(59, 130, 246)', // 青色
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2, // 点の大きさ
                        tension: 0.1,   // 線の滑らかさ
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Time vs Distance' }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time' },
                            ticks: {
                                maxTicksLimit: 20 // 目盛りが多すぎないように間引く
                            }
                        },
                        y: {
                            title: { display: true, text: 'Distance' },
                            beginAtZero: false // 0から始めない（変化を見やすくする）
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>