<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Tools - Lab Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-50 text-slate-700 antialiased">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/50 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
            <p class="text-slate-800 font-bold text-lg">Processing...</p>
            <p class="text-slate-500 text-sm mt-2">Please wait while we analyze your data.</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold mr-3">
                        L
                    </div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">Lab Portal Analysis</h1>
                </div>
                <!-- Back to Home -->
                <a href="index.html" class="text-sm text-slate-500 hover:text-blue-600 flex items-center">
                    &larr; Back to Home
                </a>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col lg:flex-row gap-8">

        <!-- Sidebar -->
        <aside class="w-full lg:w-64 flex-shrink-0">
            <div class="sticky top-24">
                <button class="lg:hidden w-full bg-white border border-slate-200 rounded-xl px-4 py-3 mb-4 flex items-center justify-between shadow-sm text-slate-700 font-bold" onclick="document.getElementById('sidebar-content').classList.toggle('hidden')">
                    <span>MENU</span>
                    <span>☰</span>
                </button>

                <div id="sidebar-content" class="hidden lg:block">
                    <nav class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-4 py-3 border-b border-slate-100 bg-slate-50">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Menu</h3>
                        </div>
                        <ul class="flex flex-col">
                            <li>
                                <a href="index.html" class="block px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600 border-l-4 border-transparent hover:border-blue-600 transition-colors">
                                    Home
                                </a>
                            </li>
                            <li>
                                <a href="#" onclick="switchMode('single')" id="menu-single" class="block px-4 py-3 text-sm font-medium text-blue-600 bg-blue-50 border-l-4 border-blue-600 transition-colors">
                                    Single File Analysis
                                </a>
                            </li>
                            <li>
                                <a href="#" onclick="switchMode('accuracy')" id="menu-accuracy" class="block px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-indigo-600 border-l-4 border-transparent hover:border-indigo-600 transition-colors">
                                    Distance Accuracy Analysis
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <!-- On this page -->
                    <div class="mt-6">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-2">On this page</h4>
                        <ul class="space-y-1">
                            <li><a href="#tool" class="block px-2 py-1 text-sm text-slate-600 hover:text-blue-600">・Analysis Tool</a></li>
                            <li><a href="#results" class="block px-2 py-1 text-sm text-slate-600 hover:text-blue-600">・Results</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 min-w-0">

            <!-- Mode Switcher (Tabs) -->
            <div class="mb-8 border-b border-slate-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button onclick="switchMode('single')" id="tab-single" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Single File Analysis
                    </button>
                    <button onclick="switchMode('accuracy')" id="tab-accuracy" class="border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Distance Accuracy Analysis
                    </button>
                </nav>
            </div>

            <!-- Single File Analysis Section -->
            <div id="section-single">
                <section id="tool" class="mb-12">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">Single File Analysis</h2>

                        <div class="flex flex-col sm:flex-row gap-4 items-center mb-6">
                            <input type="file" id="csvFile" accept=".csv"
                                   class="block w-full text-sm text-slate-500
                                          file:mr-4 file:py-2 file:px-4
                                          file:rounded-full file:border-0
                                          file:text-sm file:font-semibold
                                          file:bg-slate-100 file:text-slate-700
                                          hover:file:bg-slate-200 cursor-pointer"/>
                            <button onclick="processSingleCSV()"
                                    class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition shadow-sm whitespace-nowrap">
                                Analyze
                            </button>
                        </div>

                        <!-- Results -->
                        <div id="results-single" class="hidden border-t border-slate-100 pt-6 mt-6">
                            <!-- Filters -->
                            <div class="flex items-center gap-4 mb-6">
                                <span class="text-sm font-bold text-slate-600">Filter:</span>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="filterModeSingle" value="all" class="peer sr-only" checked onchange="updateSingleCharts()">
                                        <span class="block px-4 py-2 text-sm rounded-md transition-all text-slate-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm peer-checked:font-bold">All</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="filterModeSingle" value="los" class="peer sr-only" onchange="updateSingleCharts()">
                                        <span class="block px-4 py-2 text-sm rounded-md transition-all text-slate-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm peer-checked:font-bold">LOS only</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="filterModeSingle" value="nlos" class="peer sr-only" onchange="updateSingleCharts()">
                                        <span class="block px-4 py-2 text-sm rounded-md transition-all text-slate-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm peer-checked:font-bold">NLOS only</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="filterModeSingle" value="exc" class="peer sr-only" onchange="updateSingleCharts()">
                                        <span class="block px-4 py-2 text-sm rounded-md transition-all text-slate-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm peer-checked:font-bold">exc</span>
                                    </label>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                <!-- Stats -->
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center h-min">
                                    <div class="p-3 bg-slate-50 rounded-lg">
                                        <div class="text-xs text-slate-400 mb-1">Count</div>
                                        <div class="text-lg font-bold text-slate-800 mb-2" id="rowCount">-</div>
                                    </div>
                                    <div class="p-3 bg-slate-50 rounded-lg">
                                        <div class="text-xs text-slate-400 mb-1">Avg Dist</div>
                                        <div class="text-lg font-bold text-blue-600 mb-2" id="avgValue">-</div>
                                    </div>
                                    <div class="p-3 bg-slate-50 rounded-lg">
                                        <div class="text-xs text-slate-400 mb-1">Max Dist</div>
                                        <div class="text-lg font-bold text-green-600 mb-2" id="maxValue">-</div>
                                    </div>
                                    <div class="p-3 bg-slate-50 rounded-lg">
                                        <div class="text-xs text-slate-400 mb-1">Avg RSSI</div>
                                        <div class="text-lg font-bold text-orange-500 mb-2" id="avgRssi">-</div>
                                    </div>
                                </div>
                                <!-- Pie Chart -->
                                <div class="bg-slate-50 rounded-lg p-4 flex flex-col items-center justify-center">
                                    <h4 class="text-sm font-bold text-slate-600 mb-2">Environment (LOS / NLOS)</h4>
                                    <div class="relative h-48 w-full max-w-xs">
                                        <canvas id="nlosChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Time Series -->
                            <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-slate-600 mb-2">Time Series</h4>
                                    <div class="flex items-center gap-2">
                                        <label for="trueAvgDist" class="text-xs text-slate-500 font-medium">True Avg (cm):</label>
                                        <input type="number" id="trueAvgDist" placeholder="Optional" class="w-24 text-xs border border-slate-300 rounded px-1 py-1 text-center" onchange="updateSingleCharts()">
                                    </div>
                                </div>
                                <div class="relative h-96 w-full">
                                    <canvas id="myChart"></canvas>
                                </div>
                            </div>

                            <!-- Histogram -->
                            <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-slate-600">Distance Distribution</h4>
                                    <div class="flex items-center gap-2">
                                        <label for="binWidth" class="text-xs text-slate-500 font-medium">Bin (cm):</label>
                                        <input type="number" id="binWidth" step="0.5" min="0.5" class="w-20 text-sm border border-slate-300 rounded px-2 py-1" onchange="updateSingleCharts()">
                                    </div>
                                </div>
                                <div class="relative h-64 w-full">
                                    <canvas id="histogramChart"></canvas>
                                </div>
                            </div>

                            <hr class="border-slate-100 my-8">

                            <!-- RSSI Section -->
                            <h3 class="text-md font-bold text-slate-700 mb-4">RSSI Analysis</h3>

                            <!-- RSSI Time Series -->
                            <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm mb-6">
                                <h4 class="text-sm font-bold text-slate-600 mb-2">RSSI Time Series</h4>
                                <div class="relative h-64 w-full">
                                    <canvas id="rssiTimeSeriesChart"></canvas>
                                </div>
                            </div>

                            <!-- RSSI Histogram -->
                            <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-slate-600">RSSI Distribution</h4>
                                    <div class="flex items-center gap-2">
                                        <label for="binWidthRssi" class="text-xs text-slate-500 font-medium">Bin (dBm):</label>
                                        <input type="number" id="binWidthRssi" step="1" min="1" value="1" class="w-20 text-sm border border-slate-300 rounded px-2 py-1" onchange="updateSingleCharts()">
                                    </div>
                                </div>
                                <div class="relative h-64 w-full">
                                    <canvas id="rssiHistogramChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Accuracy Analysis Section -->
            <div id="section-accuracy" class="hidden">
                <section class="mb-12">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">Distance Accuracy Analysis</h2>

                        <!-- File Upload -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">1. Upload Measurement Files (Multiple)</label>
                            <input type="file" id="csvFilesAcc" accept=".csv" multiple
                                   class="block w-full text-sm text-slate-500
                                          file:mr-4 file:py-2 file:px-4
                                          file:rounded-full file:border-0
                                          file:text-sm file:font-semibold
                                          file:bg-indigo-50 file:text-indigo-700
                                          hover:file:bg-indigo-100 cursor-pointer"/>
                            <p class="text-xs text-slate-500 mt-2">Select multiple CSV files.</p>
                        </div>

                        <!-- Table -->
                        <div id="fileTableContainer" class="hidden mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">2. Enter True Distances</label>
                            <div class="overflow-x-auto border rounded-lg">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">File Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">True Distance (cm)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fileTableBody" class="bg-white divide-y divide-slate-200">
                                        <!-- JS Generated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Action -->
                        <div id="actionAreaAcc" class="hidden pt-4 border-t border-slate-100">
                             <div class="flex items-center gap-4 mb-4">
                                <span class="text-sm font-bold text-slate-600">Filter Mode:</span>
                                <div class="flex bg-slate-100 p-1 rounded-lg">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="filterModeAcc" value="all" class="peer sr-only" checked>
                                        <span class="block px-4 py-2 text-sm rounded-md transition-all text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm peer-checked:font-bold">All</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="filterModeAcc" value="los" class="peer sr-only">
                                        <span class="block px-4 py-2 text-sm rounded-md transition-all text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm peer-checked:font-bold">LOS only</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="filterModeAcc" value="nlos" class="peer sr-only">
                                        <span class="block px-4 py-2 text-sm rounded-md transition-all text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm peer-checked:font-bold">NLOS only</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="filterModeAcc" value="exc" class="peer sr-only">
                                        <span class="block px-4 py-2 text-sm rounded-md transition-all text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm peer-checked:font-bold">exc</span>
                                    </label>
                                </div>
                            </div>
                            <button onclick="runAccuracyAnalysis()"
                                    class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-8 rounded-lg transition shadow-sm whitespace-nowrap">
                                Analyze
                            </button>
                        </div>

                        <!-- Accuracy Results -->
                        <div id="results-accuracy" class="hidden mt-8 border-t border-slate-100 pt-6">
                             <h2 class="text-lg font-bold text-slate-800 mb-4">Accuracy Characteristics</h2>
                             <div class="relative h-96 w-full">
                                <canvas id="accuracyChart"></canvas>
                             </div>
                        </div>
                    </div>
                </section>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script>
        // Global State
        let currentMode = 'single';

        // Chart Instances
        let singleCharts = {
            line: null,
            hist: null,
            pie: null,
            rssiLine: null,
            rssiHist: null
        };
        let accuracyChart = null;
        let singleRawData = [];

        // Plugins for Lines
        const horizontalLinePlugin = {
            id: 'horizontalLinePlugin',
            afterDatasetsDraw(chart, args, options) {
                const { ctx, chartArea: { left, right, top, bottom }, scales: { y } } = chart;
                if (!options.lines) return;
                ctx.save();
                options.lines.forEach(line => {
                    const yVal = line.value;
                    if (yVal == null || isNaN(yVal)) return;
                    // Check if y scale handles this value (in case of dual axis, we assume 'y' for horizontal lines unless specified)
                    // But here we rely on 'y' scale being present.
                    if (!y) return;
                    const yPixel = y.getPixelForValue(yVal);
                    if (yPixel < top || yPixel > bottom) return;
                    ctx.beginPath();
                    ctx.strokeStyle = line.color || 'red';
                    ctx.lineWidth = line.width || 2;
                    ctx.moveTo(left, yPixel);
                    ctx.lineTo(right, yPixel);
                    ctx.stroke();
                });
                ctx.restore();
            }
        };

        const verticalLinePlugin = {
            id: 'verticalLinePlugin',
            afterDatasetsDraw(chart, args, options) {
                 const { ctx, chartArea: { left, right, top, bottom }, scales: { x } } = chart;
                 if (!options.lines) return;
                 const min = options.min;
                 const binWidth = options.binWidth;
                 const totalWidth = right - left;
                 const range = options.range;

                 ctx.save();
                 options.lines.forEach(line => {
                    const val = line.value;
                    if (val == null || isNaN(val)) return;
                    let xPixel;
                    if (range && binWidth) {
                         const offset = val - min;
                         const ratio = offset / range;
                         xPixel = left + (ratio * totalWidth);
                    } else {
                        xPixel = x.getPixelForValue(val);
                    }
                    if (xPixel < left || xPixel > right) return;
                    ctx.beginPath();
                    ctx.strokeStyle = line.color || 'red';
                    ctx.lineWidth = line.width || 2;
                    ctx.moveTo(xPixel, top);
                    ctx.lineTo(xPixel, bottom);
                    ctx.stroke();
                 });
                 ctx.restore();
            }
        };

        // --- Init ---
        function checkHash() {
            if (window.location.hash === '#accuracy') {
                switchMode('accuracy');
            } else {
                switchMode('single');
            }
        }
        window.onload = checkHash;

        function switchMode(mode) {
            currentMode = mode;
            const secSingle = document.getElementById('section-single');
            const secAcc = document.getElementById('section-accuracy');

            const tabSingle = document.getElementById('tab-single');
            const tabAcc = document.getElementById('tab-accuracy');

            const menuSingle = document.getElementById('menu-single');
            const menuAcc = document.getElementById('menu-accuracy');

            if (mode === 'single') {
                secSingle.classList.remove('hidden');
                secAcc.classList.add('hidden');

                // Tabs
                tabSingle.className = "border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                tabAcc.className = "border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";

                // Menu
                menuSingle.className = "block px-4 py-3 text-sm font-medium text-blue-600 bg-blue-50 border-l-4 border-blue-600 transition-colors";
                menuAcc.className = "block px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-indigo-600 border-l-4 border-transparent hover:border-indigo-600 transition-colors";

            } else {
                secSingle.classList.add('hidden');
                secAcc.classList.remove('hidden');

                // Tabs
                tabSingle.className = "border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                tabAcc.className = "border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";

                // Menu
                menuSingle.className = "block px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600 border-l-4 border-transparent hover:border-blue-600 transition-colors";
                menuAcc.className = "block px-4 py-3 text-sm font-medium text-indigo-600 bg-indigo-50 border-l-4 border-indigo-600 transition-colors";
            }
        }

        // --- Single Analysis Logic ---
        function processSingleCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) { alert("Please select a file."); return; }

            document.getElementById('loadingOverlay').classList.remove('hidden');

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                transformHeader: h => h.trim(),
                complete: function(results) {
                    singleRawData = results.data;
                    updateSingleCharts();
                    document.getElementById('results-single').classList.remove('hidden');
                    document.getElementById('loadingOverlay').classList.add('hidden');
                },
                error: function(err) {
                    alert("Error parsing CSV: " + err);
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }
            });
        }

        function updateSingleCharts() {
            if (singleRawData.length === 0) return;
            const filterMode = document.querySelector('input[name="filterModeSingle"]:checked').value;

            let filtered = singleRawData;
            if (filterMode === 'los') filtered = singleRawData.filter(d => d.nlos === 0);
            if (filterMode === 'nlos') filtered = singleRawData.filter(d => d.nlos === 1);
            if (filterMode === 'exc') filtered = singleRawData.filter(d => d.nlos !== -1);

            // Stats
            const distances = filtered.map(d => d.distance).filter(d => typeof d === 'number');
            const rssiVals = filtered.map(d => d.rssi).filter(d => typeof d === 'number');

            const count = distances.length;
            const sum = distances.reduce((a,b)=>a+b,0);
            const avg = count > 0 ? (sum/count).toFixed(2) : 0;
            const max = count > 0 ? Math.max(...distances) : 0;

            const sumRssi = rssiVals.reduce((a,b)=>a+b,0);
            const avgRssi = rssiVals.length > 0 ? (sumRssi/rssiVals.length).toFixed(1) : 0;

            document.getElementById('rowCount').innerText = count + " rows";
            document.getElementById('avgValue').innerText = avg + " cm";
            document.getElementById('maxValue').innerText = max + " cm";
            document.getElementById('avgRssi').innerText = avgRssi + " dBm";

            // Pie
            drawSinglePie(singleRawData);

            // Line & Hist
            const labels = filtered.map(d => d.time);
            drawSingleLine(labels, distances);
            drawSingleHist(distances);

            // RSSI Charts
            drawRssiLine(labels, rssiVals);
            drawRssiHist(rssiVals);
        }

        function drawSinglePie(data) {
            const los = data.filter(d => d.nlos === 0).length;
            const nlos = data.filter(d => d.nlos === 1).length;
            const ctx = document.getElementById('nlosChart').getContext('2d');
            if (singleCharts.pie) singleCharts.pie.destroy();
            singleCharts.pie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['LOS', 'NLOS'],
                    datasets: [{
                        data: [los, nlos],
                        backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(239, 68, 68, 0.8)']
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position:'bottom' } } }
            });
        }

        function drawSingleLine(labels, data) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (singleCharts.line) singleCharts.line.destroy();

            const trueAvg = parseFloat(document.getElementById('trueAvgDist').value);
            const lines = [];
            if (!isNaN(trueAvg)) lines.push({ value: trueAvg, color: 'red' });

            singleCharts.line = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Distance',
                        data: data,
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.05)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { horizontalLinePlugin: { lines: lines } },
                    scales: { x: { ticks: { maxTicksLimit: 12 } } }
                },
                plugins: [horizontalLinePlugin]
            });
        }

        function drawSingleHist(data) {
             const ctx = document.getElementById('histogramChart').getContext('2d');
             if (singleCharts.hist) singleCharts.hist.destroy();
             if (data.length === 0) return;

             const min = Math.min(...data);
             const max = Math.max(...data);
             let binWidth = parseFloat(document.getElementById('binWidth').value) || 5;
             const binCount = Math.min(Math.ceil((max - min)/binWidth), 1000);

             const bins = new Array(binCount).fill(0);
             const binLabels = [];
             for(let i=0; i<binCount; i++){
                 const s = min + i*binWidth;
                 const e = min + (i+1)*binWidth;
                 binLabels.push(`${s.toFixed(1)}-${e.toFixed(1)}`);
             }
             data.forEach(v => {
                 let idx = Math.floor((v-min)/binWidth);
                 if (idx >= binCount) idx = binCount-1;
                 if (idx < 0) idx = 0;
                 bins[idx]++;
             });

             const trueAvg = parseFloat(document.getElementById('trueAvgDist').value);
             const vLines = [];
             if (!isNaN(trueAvg)) vLines.push({ value: trueAvg, color: 'red' });

             singleCharts.hist = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: binLabels,
                     datasets: [{
                         label: 'Frequency',
                         data: bins,
                         backgroundColor: 'rgba(59, 130, 246, 0.6)'
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: { display: false },
                         verticalLinePlugin: { lines: vLines, min: min, binWidth: binWidth, range: binCount*binWidth }
                     },
                     scales: { x: { display: false } }
                 },
                 plugins: [verticalLinePlugin]
             });
        }

        function drawRssiLine(labels, data) {
            const ctx = document.getElementById('rssiTimeSeriesChart').getContext('2d');
            if (singleCharts.rssiLine) singleCharts.rssiLine.destroy();

            singleCharts.rssiLine = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'RSSI (dBm)',
                        data: data,
                        borderColor: 'rgb(249, 115, 22)', // Orange-500
                        backgroundColor: 'rgba(249, 115, 22, 0.05)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { maxTicksLimit: 12 } },
                        y: {
                            title: { display: true, text: 'RSSI (dBm)' },
                            suggestedMax: -20,
                            suggestedMin: -100
                        }
                    }
                }
            });
        }

        function drawRssiHist(data) {
             const ctx = document.getElementById('rssiHistogramChart').getContext('2d');
             if (singleCharts.rssiHist) singleCharts.rssiHist.destroy();
             if (data.length === 0) return;

             const min = Math.min(...data);
             const max = Math.max(...data);
             let binWidth = parseFloat(document.getElementById('binWidthRssi').value) || 1;
             const binCount = Math.min(Math.ceil((max - min)/binWidth), 1000);

             const bins = new Array(binCount).fill(0);
             const binLabels = [];
             for(let i=0; i<binCount; i++){
                 const s = min + i*binWidth;
                 const e = min + (i+1)*binWidth;
                 binLabels.push(`${s.toFixed(1)}-${e.toFixed(1)}`);
             }
             data.forEach(v => {
                 let idx = Math.floor((v-min)/binWidth);
                 if (idx >= binCount) idx = binCount-1;
                 if (idx < 0) idx = 0;
                 bins[idx]++;
             });

             singleCharts.rssiHist = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: binLabels,
                     datasets: [{
                         label: 'Frequency',
                         data: bins,
                         backgroundColor: 'rgba(249, 115, 22, 0.6)' // Orange
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: { display: false },
                     },
                     scales: { x: { display: false } }
                 }
             });
        }

        // --- Accuracy Analysis Logic ---

        document.getElementById('csvFilesAcc').addEventListener('change', function(e) {
            const files = e.target.files;
            const tbody = document.getElementById('fileTableBody');
            tbody.innerHTML = '';
            if (files.length > 0) {
                Array.from(files).forEach((file, idx) => {
                    const row = `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${file.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                            <input type="number" class="true-dist-input block w-32 border border-slate-300 rounded px-2 py-1" data-idx="${idx}">
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                document.getElementById('fileTableContainer').classList.remove('hidden');
                document.getElementById('actionAreaAcc').classList.remove('hidden');
            } else {
                document.getElementById('fileTableContainer').classList.add('hidden');
                document.getElementById('actionAreaAcc').classList.add('hidden');
            }
        });

        async function runAccuracyAnalysis() {
            const files = document.getElementById('csvFilesAcc').files;
            const inputs = document.querySelectorAll('.true-dist-input');
            const filterMode = document.querySelector('input[name="filterModeAcc"]:checked').value;

            // Validate
            const configs = [];
            for(let i=0; i<files.length; i++) {
                const val = inputs[i].value;
                if (!val) { alert(`Enter true distance for ${files[i].name}`); return; }
                configs.push({ file: files[i], trueDist: parseFloat(val) });
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                const results = await Promise.all(configs.map(c => parseFileWorker(c.file)));

                const plotData = [];
                results.forEach((data, i) => {
                    const avgs = calcAvg(data, filterMode);
                    plotData.push({
                        x: configs[i].trueDist,
                        y: avgs.dist,
                        rssi: avgs.rssi
                    });
                });

                plotData.sort((a,b) => a.x - b.x);

                drawAccuracyChart(plotData);
                document.getElementById('results-accuracy').classList.remove('hidden');
                document.getElementById('results-accuracy').scrollIntoView({behavior:'smooth'});

            } catch (e) {
                alert("Analysis failed: " + e);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function parseFileWorker(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    worker: true,
                    complete: (results) => {
                        // Post-process header trimming
                        const clean = results.data.map(r => {
                            const nr = {};
                            Object.keys(r).forEach(k => nr[k.trim()] = r[k]);
                            return nr;
                        });
                        resolve(clean);
                    },
                    error: reject
                });
            });
        }

        function calcAvg(data, mode) {
            let f = data;
            if (mode === 'los') f = data.filter(d => d.nlos === 0);
            if (mode === 'nlos') f = data.filter(d => d.nlos === 1);
            if (mode === 'exc') f = data.filter(d => d.nlos !== -1);

            if (f.length === 0) return { dist: 0, rssi: 0 };

            const dists = f.map(d => d.distance).filter(v => typeof v === 'number');
            const rssis = f.map(d => d.rssi).filter(v => typeof v === 'number');

            const avgDist = dists.length > 0 ? dists.reduce((a,b)=>a+b,0)/dists.length : 0;
            const avgRssi = rssis.length > 0 ? rssis.reduce((a,b)=>a+b,0)/rssis.length : 0;

            return { dist: avgDist, rssi: avgRssi };
        }

        function drawAccuracyChart(data) {
            const ctx = document.getElementById('accuracyChart').getContext('2d');
            if (accuracyChart) accuracyChart.destroy();

            const maxX = data.length > 0 ? data[data.length-1].x : 100;
            const limit = Math.ceil(maxX * 1.1);

            const distData = data.map(d => ({ x: d.x, y: d.y }));
            const rssiData = data.map(d => ({ x: d.x, y: d.rssi }));

            accuracyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Measured Avg Dist (cm)',
                            data: distData,
                            borderColor: 'rgb(79, 70, 229)', // Indigo
                            backgroundColor: 'rgba(79, 70, 229, 0.5)',
                            borderWidth: 2,
                            pointRadius: 4,
                            fill: false,
                            tension: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Avg RSSI (dBm)',
                            data: rssiData,
                            borderColor: 'rgb(249, 115, 22)', // Orange
                            backgroundColor: 'rgba(249, 115, 22, 0.5)',
                            borderWidth: 2,
                            pointRadius: 4,
                            fill: false,
                            tension: 0,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Ideal (y=x)',
                            data: [{x:0, y:0}, {x:limit, y:limit}],
                            borderColor: 'rgba(148, 163, 184, 0.8)',
                            borderWidth: 2,
                            borderDash: [5,5],
                            pointRadius: 0,
                            fill: false,
                            yAxisID: 'y' // Bind to distance axis
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'True Distance (cm)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: 'Distance (cm)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'RSSI (dBm)' },
                            // Typically RSSI is negative, so we don't force beginAtZero
                            grid: {
                                drawOnChartArea: false // only want the grid lines for one axis to show up
                            }
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>